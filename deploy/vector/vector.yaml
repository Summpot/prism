# Vector configuration for the Prism docker-compose stack.
#
# - Collects Prism JSON logs from container stdout.
# - Forwards logs to Quickwit (NDJSON ingest).
#
# Metrics are scraped directly by VictoriaMetrics from Prism's /metrics endpoint.

sources:
  docker_prism:
    type: docker_logs
    include_containers:
      - prism-backend

transforms:
  parse_prism_json:
    type: remap
    inputs: [docker_prism]
    source: |
      # docker_logs provides a timestamp; keep a stable field name for Quickwit.
      if !exists(.timestamp) {
        .timestamp = now()
      }

      # Prism emits JSON logs via tracing-subscriber. The docker_logs source exposes the log line
      # as `.message`.
      if is_string(.message) {
        parsed, err = parse_json(.message)
        if err == null {
          . = merge(., parsed)
        }
      }

sinks:
  quickwit_logs:
    type: http
    inputs: [parse_prism_json]
    uri: http://quickwit:7280/api/v1/prism-logs/ingest?commit=auto
    method: post
    encoding:
      codec: ndjson
    batch:
      max_events: 1000
      timeout_secs: 1
