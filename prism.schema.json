{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/Summpot/prism/master/prism.schema.json",
  "title": "Prism configuration",
  "description": "JSON Schema for Prism .toml and .yaml/.yml configuration files.",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "listeners": {
      "type": "array",
      "description": "Public-facing proxy listeners (multi-port / multi-protocol).",
      "items": { "$ref": "#/$defs/proxyListener" }
    },
    "admin_addr": {
      "type": "string",
      "description": "Admin HTTP server listen address. Empty disables the admin server.",
      "examples": [":8080", "127.0.0.1:8080", ""]
    },
    "logging": { "$ref": "#/$defs/logging" },
    "routes": {
      "type": "array",
      "description": "Ordered hostname routes. Routes are matched in order; each route targets one or more upstreams. TCP hostname extraction and optional prelude rewrites are provided by per-route wasm middlewares.",
      "items": { "$ref": "#/$defs/route" },
      "default": [],
      "examples": [
        [
          {
            "host": "play.example.com",
            "upstream": "127.0.0.1:25566",
            "middlewares": ["minecraft_handshake"]
          },
          {
            "host": "*.labs.example.com",
            "upstreams": ["127.0.0.1:25567", "127.0.0.1:25568"],
            "strategy": "round-robin",
            "middlewares": ["minecraft_handshake"]
          },
          {
            "host": "home.example.com",
            "upstream": "tunnel:home-mc",
            "middlewares": ["minecraft_handshake"]
          }
        ]
      ]
    },
    "max_header_bytes": {
      "type": "integer",
      "minimum": 0,
      "description": "Maximum number of bytes to peek/read for routing (handshake/SNI/etc). 0 means use the default.",
      "examples": [65536]
    },
    "reload": { "$ref": "#/$defs/reload" },
    "proxy_protocol_v2": {
      "type": "boolean",
      "description": "Whether to inject HAProxy PROXY protocol v2 headers on TCP upstream connections (to preserve the original client IP/port at the backend).",
      "default": false
    },
    "buffer_size": {
      "type": "integer",
      "minimum": 0,
      "description": "Buffer size (bytes) used for proxying. 0 means use the default.",
      "examples": [32768]
    },
    "upstream_dial_timeout_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Dial timeout for upstream connections (milliseconds). 0 means use the default.",
      "examples": [5000]
    },
    "timeouts": { "$ref": "#/$defs/timeouts" },
    "tunnel": { "$ref": "#/$defs/tunnel" }
  },
  "$defs": {
    "nonEmptyString": {
      "type": "string",
      "minLength": 1
    },
    "stringOrStrings": {
      "description": "Either a single string or a list of strings.",
      "oneOf": [
        { "$ref": "#/$defs/nonEmptyString" },
        {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        }
      ]
    },
    "ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Duration in milliseconds."
    },
    "proxyListener": {
      "type": "object",
      "additionalProperties": false,
      "required": ["listen_addr"],
      "properties": {
        "listen_addr": {
          "$ref": "#/$defs/nonEmptyString",
          "description": "Listener address.",
          "examples": [":25565"]
        },
        "protocol": {
          "type": "string",
          "description": "Listener protocol.",
          "enum": ["tcp", "udp"],
          "default": "tcp"
        },
        "upstream": {
          "type": "string",
          "description": "Forward target. For tcp: empty means hostname-routing mode; non-empty means fixed forward mode. For udp: required.",
          "examples": ["127.0.0.1:19132", "tunnel:home-mc", ""]
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "protocol": { "const": "udp" } },
            "required": ["protocol"]
          },
          "then": {
            "required": ["upstream"],
            "properties": {
              "upstream": { "$ref": "#/$defs/nonEmptyString" }
            }
          }
        }
      ]
    },
    "logging": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "level": {
          "type": "string",
          "description": "Log level.",
          "enum": ["debug", "info", "warn", "error"],
          "default": "info"
        },
        "format": {
          "type": "string",
          "description": "Log format.",
          "enum": ["json", "text"],
          "default": "json"
        },
        "output": {
          "type": "string",
          "description": "Log output: stderr, stdout, discard, or a file path.",
          "default": "stderr",
          "examples": ["stderr", "stdout", "discard", "./prism.log"]
        },
        "add_source": {
          "type": "boolean",
          "description": "Include source file/line in logs (slightly higher overhead).",
          "default": false
        }
      }
    },
    
    "reload": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable automatic reload watching (file-based provider only).",
          "default": true
        },
        "poll_interval_ms": {
          "$ref": "#/$defs/ms",
          "description": "How often to poll for file changes (milliseconds).",
          "default": 1000
        }
      }
    },
    "timeouts": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "handshake_timeout_ms": {
          "$ref": "#/$defs/ms",
          "description": "Timeout for reading the initial handshake/header for routing.",
          "default": 3000
        },
        "idle_timeout_ms": {
          "$ref": "#/$defs/ms",
          "description": "Optional idle timeout for connections. 0 means disabled.",
          "default": 0
        }
      }
    },
    "tunnel": {
      "type": "object",
      "additionalProperties": false,
      "description": "Reverse-connection mode (client -> server) for reaching private backends.",
      "properties": {
        "auth_token": {
          "type": "string",
          "description": "Optional shared secret required for tunnel client registration.",
          "default": ""
        },
        "auto_listen_services": {
          "type": "boolean",
          "description": "When true, Prism auto-opens server-side listeners for services that set remote_addr.",
          "default": true
        },
        "endpoints": {
          "type": "array",
          "description": "Tunnel server endpoints.",
          "items": { "$ref": "#/$defs/tunnelEndpoint" }
        },
        "client": { "$ref": "#/$defs/tunnelClient" },
        "services": {
          "type": "array",
          "description": "Tunnel client registered services.",
          "items": { "$ref": "#/$defs/tunnelService" }
        }
      }
    },
    "tunnelEndpoint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["listen_addr"],
      "properties": {
        "listen_addr": { "$ref": "#/$defs/nonEmptyString" },
        "transport": {
          "type": "string",
          "enum": ["tcp", "udp", "quic"],
          "default": "tcp"
        },
        "quic": { "$ref": "#/$defs/quicServer" }
      }
    },
    "quicServer": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "cert_file": {
          "type": "string",
          "description": "Path to TLS certificate PEM file. If empty, Prism may generate a self-signed cert.",
          "default": ""
        },
        "key_file": {
          "type": "string",
          "description": "Path to TLS private key PEM file. If empty, Prism may generate a self-signed key.",
          "default": ""
        }
      }
    },
    "tunnelClient": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "server_addr": {
          "$ref": "#/$defs/nonEmptyString",
          "description": "Tunnel server address."
        },
        "transport": {
          "type": "string",
          "enum": ["tcp", "udp", "quic"],
          "default": "tcp"
        },
        "dial_timeout_ms": {
          "$ref": "#/$defs/ms",
          "description": "Dial timeout for connecting to the tunnel server.",
          "default": 5000
        },
        "quic": { "$ref": "#/$defs/quicClient" }
      }
    },
    "quicClient": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "server_name": {
          "type": "string",
          "description": "TLS SNI / server name used for QUIC.",
          "default": ""
        },
        "insecure_skip_verify": {
          "type": "boolean",
          "description": "Skip TLS verification (dev/testing only).",
          "default": false
        }
      }
    },
    "tunnelService": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "local_addr"],
      "properties": {
        "name": { "$ref": "#/$defs/nonEmptyString" },
        "proto": {
          "type": "string",
          "enum": ["tcp", "udp"],
          "default": "tcp"
        },
        "local_addr": { "$ref": "#/$defs/nonEmptyString" },
        "route_only": {
          "type": "boolean",
          "description": "If true, only reachable via routes (tunnel:<service>) and never exposed via remote_addr.",
          "default": false
        },
        "remote_addr": {
          "type": "string",
          "description": "Optional server-side listener request (frp-like). Must not be set when route_only=true.",
          "examples": [":25565", ""]
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "route_only": { "const": true } },
            "required": ["route_only"]
          },
          "then": {
            "not": { "required": ["remote_addr"] }
          }
        }
      ]
    }
    ,
    "route": {
      "type": "object",
      "additionalProperties": false,
      "required": ["host"],
      "properties": {
        "host": {
          "$ref": "#/$defs/stringOrStrings",
          "description": "Host pattern(s) to match. Supports '*' and '?' wildcards (case-insensitive). Examples: 'play.example.com', '*.example.com', '*'"
        },
        "hosts": {
          "$ref": "#/$defs/stringOrStrings",
          "description": "Alias of host."
        },
        "upstream": {
          "$ref": "#/$defs/stringOrStrings",
          "description": "Upstream target(s) (host:port or tunnel:<service>). $1, $2... are substituted from wildcard capture groups."
        },
        "upstreams": {
          "$ref": "#/$defs/stringOrStrings",
          "description": "Alias of upstream."
        },
        "backend": {
          "$ref": "#/$defs/stringOrStrings",
          "description": "Alias of upstream (gate-lite compatible naming)."
        },
        "backends": {
          "$ref": "#/$defs/stringOrStrings",
          "description": "Alias of upstreams (gate-lite compatible naming)."
        },
        "middlewares": {
          "$ref": "#/$defs/stringOrStrings",
          "description": "Ordered wasm middleware names to apply for this route (name only; do not include .wat). Middlewares can parse hostnames and can optionally rewrite the captured prelude before proxying upstream."
        },
        "parsers": {
          "$ref": "#/$defs/stringOrStrings",
          "description": "Deprecated alias of middlewares (kept for backward compatibility)."
        },
        "strategy": {
          "type": "string",
          "description": "Load balancing strategy when multiple upstreams are configured.",
          "enum": ["sequential", "random", "round-robin"],
          "default": "sequential"
        }
      },
      "allOf": [
        {
          "anyOf": [
            { "required": ["upstream"] },
            { "required": ["upstreams"] },
            { "required": ["backend"] },
            { "required": ["backends"] }
          ]
        },
        {
          "anyOf": [
            { "required": ["middlewares"] },
            { "required": ["parsers"] }
          ]
        }
      ]
    }
  }
}
